# Оглавление

1. [Задача](#задача)  
2. [Решение](#решение)  
   2.1. [Дисклеймер](#дисклеймер)  
   2.2. [Инструкция по сборке](#инструкция-по-сборке)  
       2.2.1. [Требования к окружению](#требования-к-окружению)  
       2.2.2. [Шаги сборки](#шаги-сборки)  
   2.3. [Описание](#описание)  
3. [Запуск проекта](#запуск-проекта)  
4. [Проверка работы](#проверка-работы)  
5. [Архитектура решения](#архитектура-решения)  
6. [Возникшие вопросы и решения](#возникшие-вопросы-и-решения)  

---

# Задача

[↑ Вернуться к оглавлению](#оглавление)

Реализовать консольное приложение, которое будет устанавливать PostgreSQL на удаленный хост, настраивать и запускать.

Вводные: 2 сервера, один на Debian, второй на CentOS (AlmaLinux). На обоих серверах пользователю root подложен один и тот же открытый ssh ключ. У исполнителя есть закрытая часть ключа, с помощью которой он подключается.

---

**Реализация должна включать:**

- подключение к удаленным хостам по ssh  
- оценку загруженности серверов, выбор наименее нагруженного из серверов как целевого  
- инсталляцию PostgreSQL на целевой хост  
- настройку PostgreSQL для приема внешних соединений, т.е. БД должна отвечать на sql-запросы с внешних ip-адресов  
- настройку подключения пользователя “student” к PostgreSql только с ip адреса второго сервера.  

**Требования**

- приложение принимает один строковый параметр - ip адреса или имена серверов одной строкой, разделитель - запятая  
- приложение должно сообщать статус выполнения инсталляции  

**Будет плюсом**

- приложение выполняет проверку работы БД, выполняя sql запрос (SELECT 1)  

**Требования к коду**

- язык разработки: bash, python, ansible  
- библиотеки можно использовать любые  
- код должен быть выложен на Github с Readme файлом с инструкцией по запуску и примерами. Важно, чтобы по инструкции можно было запустить код и он работал  
- при возникновении вопросов по ТЗ оставляем принятие решения за тобой.  

Желательно отразить в Readme, какие вопросы возникали и какие решения были приняты  

---

# Решение

## Дисклеймер

[↑ Вернуться к оглавлению](#оглавление)

Изображения в `README.md` могут загрузиться не сразу, дождитесь полной загрузки.

## Инструкция по сборке

[↑ Вернуться к оглавлению](#оглавление)

### Требования к окружению

[↑ Вернуться к оглавлению](#оглавление)

**Для успешной сборки необходимо установить:**

- `Docker`  
- `python3`, `pip`  

### Шаги сборки

1. Скачать проект

```bash
git clone https://github.com/bashkir777/pg-start-test-task
```

2. Перейти в корень проекта

```bash
cd pg-start-test-task
```

3. Установить необходимые зависимости

```bash
pip install -r entrypoint/requirements.txt
```

4. Убедиться, что docker демон запущен, если нет — запустить

```bash
docker info
```

5. Зайти в директорию `entrypoint`. **Обязательный шаг**

```bash
cd entrypoint
```

6. Запустить файл `main.py` и дождаться завершения работы.

```bash
python3 main.py
```

После этого будет инициализирована вся инфраструктура проекта и запущена программа `pg-deployer`. Выполнение программы может занять несколько минут.

Пример логов, которые будут получены:  
![логи](img/logs-sample.png)

Чтобы ознакомиться с результатами работы программы более подробно, можно подключаться к docker контейнерам с использованием вкладки `Exec` в UI Docker Desktop (либо через терминал)

Пример, как можно убедиться, что кластер postgres действительно сконфигурирован и запущен.  
![логи](img/docker-ui-1.png)

## Описание

[↑ Вернуться к оглавлению](#оглавление)

Для удобства проверки и отсутствия расходов на виртуальные машины я решил реализовать поставленную задачу с использованием docker контейнеров, которые эмулируют реальные сервера.

Я разбил задачу на три части:

1. Написание [пакета](entrypoint/infra_entrypoint/README.md), предоставляющего инфраструктуру для выполнения ТЗ (два Linux сервера, с работающими ssh-демонами, и сервер с Ansible Control Node)  
2. Написание [приложения](pg-deployer/README.md) по ТЗ (далее `pg-deployer`), которое будет загружено на Ansible Control Node.  
3. Написание входной точки — задача которой инициализировать сборку инфраструктуры, дождаться её завершения, подключиться к Ansible Control Node и запустить `pg-deployer`, передав входными параметрами имена серверов.  

---

# Запуск проекта

[↑ Вернуться к оглавлению](#оглавление)

См. раздел [Инструкция по сборке](#инструкция-по-сборке) — запуск осуществляется через `main.py` из директории `entrypoint`.

---

# Проверка работы

[↑ Вернуться к оглавлению](#оглавление)

- После запуска можно подключиться к контейнерам и вручную выполнить проверку PostgreSQL (например, `psql -c "SELECT 1"`).  
- Также логи автоматически показывают успешную установку и конфигурацию PostgreSQL.

---

# Архитектура решения

[↑ Вернуться к оглавлению](#оглавление)

Если не отображается, поставьте светлую тему в браузере.

![схема](img/schema.png)

---

# Возникшие вопросы и решения

[↑ Вернуться к оглавлению](#оглавление)

- Почему было решено использовать docker вместо реальных серверов?  
  Чтобы обеспечить лёгкую проверку без затрат на реальные виртуальные машины.  

- Почему выбран Ansible как инструмент управления?  
  Прост в использовании, подходит для настройки и автоматизации серверов.  

- Как обрабатывается ssh-доступ?  
  На всех серверах уже лежит открытый ключ, приватный ключ используется для подключения.  
